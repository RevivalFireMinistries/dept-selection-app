{% extends "base.html" %}

{% block title %}Submit Appeal - RFM Stellenbosch 2026{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-amber-100 via-yellow-50 to-orange-100">
    <!-- Header -->
    <div class="sticky top-0 z-10 backdrop-blur-lg bg-white/70 shadow-sm">
        <div class="max-w-md mx-auto px-4 py-4 sm:py-6">
            <div class="flex items-center gap-3">
                <a href="/results" class="text-gray-500 hover:text-gray-700 p-1">
                    <svg class="w-5 h-5 sm:w-6 sm:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                    </svg>
                </a>
                <div>
                    <h1 class="text-xl sm:text-2xl font-bold bg-gradient-to-r from-amber-600 to-orange-600 bg-clip-text text-transparent">
                        Submit Appeal
                    </h1>
                    <p class="text-gray-600 text-xs sm:text-sm">RFM Stellenbosch 2026</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="max-w-md mx-auto px-4 py-6">
        <!-- Loading -->
        <div id="loading" class="flex justify-center py-12">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-amber-600"></div>
        </div>

        <!-- Error State -->
        <div id="errorState" class="hidden bg-white rounded-2xl shadow-lg p-6 text-center">
            <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                </svg>
            </div>
            <h3 class="text-lg font-semibold text-gray-900" id="errorTitle">Error</h3>
            <p class="text-gray-500 mt-2" id="errorMessage"></p>
            <a href="/results" class="inline-block mt-4 text-amber-600 hover:underline">Back to Results</a>
        </div>

        <!-- Appeal Form -->
        <div id="appealForm" class="hidden space-y-4">
            <!-- Info Banner -->
            <div class="bg-amber-50 border border-amber-200 rounded-xl p-4">
                <p class="text-sm text-amber-800">
                    <strong>Submitting appeal for:</strong> <span id="memberName"></span>
                </p>
            </div>

            <!-- Current Departments -->
            <div class="bg-white rounded-2xl shadow-lg p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Your Current Approved Departments</h3>
                <div id="currentDepartments" class="space-y-2"></div>
            </div>

            <!-- Appeal Details -->
            <div class="bg-white rounded-2xl shadow-lg p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Appeal Details</h3>

                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            Department you don't want <span class="text-gray-400">(optional)</span>
                        </label>
                        <select id="unwantedDept"
                            class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-amber-500">
                            <option value="">-- Select department --</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            Department you want instead <span class="text-gray-400">(optional)</span>
                        </label>
                        <select id="wantedDept"
                            class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-amber-500">
                            <option value="">-- Select department --</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            Reason for appeal <span class="text-gray-400">(optional)</span>
                        </label>
                        <textarea id="reason" rows="4" placeholder="Explain why you're appealing..."
                            class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-amber-500 resize-none"></textarea>
                    </div>
                </div>
            </div>

            <!-- Submit Button -->
            <button onclick="submitAppeal()" id="submitBtn"
                class="w-full py-4 bg-gradient-to-r from-amber-600 to-orange-600 text-white font-semibold rounded-xl hover:opacity-90 transition-opacity">
                Submit Appeal
            </button>

            <!-- Form Error -->
            <div id="formError" class="hidden p-4 bg-red-50 border border-red-200 text-red-700 rounded-xl text-sm"></div>
        </div>

        <!-- Success State -->
        <div id="successState" class="hidden bg-white rounded-2xl shadow-lg p-6 text-center">
            <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
            </div>
            <h3 class="text-lg font-semibold text-gray-900">Appeal Submitted</h3>
            <p class="text-gray-500 mt-2">Your appeal has been submitted and will be reviewed by the admin team.</p>
            <a href="/" class="inline-block mt-4 px-6 py-2 bg-gray-100 text-gray-700 rounded-xl hover:bg-gray-200">
                Back to Home
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let phone = '';
let memberData = null;
let allDepartments = [];

document.addEventListener('DOMContentLoaded', init);

async function init() {
    // Get phone from URL
    const params = new URLSearchParams(window.location.search);
    phone = params.get('phone');

    if (!phone) {
        showError('Missing phone number', 'Please access this page from the results page.');
        return;
    }

    try {
        // Fetch member results and all departments
        const [resultsRes, deptsRes] = await Promise.all([
            fetch(`/api/results?phone=${encodeURIComponent(phone)}`).then(r => r.json()),
            fetch('/api/departments').then(r => r.json())
        ]);

        // Check if published and appeal window open
        if (!resultsRes.published) {
            showError('Results Not Published', 'Results are not yet available.');
            return;
        }

        if (!resultsRes.appeal_window_open) {
            showError('Appeal Window Closed', 'The appeal window is currently closed.');
            return;
        }

        if (resultsRes.message && resultsRes.message.includes('No submission')) {
            showError('Member Not Found', 'No submission found for this phone number.');
            return;
        }

        memberData = resultsRes;

        // Flatten all departments
        allDepartments = [];
        (deptsRes.categories || []).forEach(cat => {
            cat.departments.forEach(d => {
                allDepartments.push({ ...d, categoryName: cat.name });
            });
        });
        (deptsRes.uncategorized || []).forEach(d => {
            allDepartments.push({ ...d, categoryName: null });
        });

        showAppealForm();

    } catch (error) {
        console.error('Init error:', error);
        showError('Error', 'Failed to load data. Please try again.');
    }
}

function showError(title, message) {
    document.getElementById('loading').classList.add('hidden');
    document.getElementById('errorState').classList.remove('hidden');
    document.getElementById('errorTitle').textContent = title;
    document.getElementById('errorMessage').textContent = message;
}

function showAppealForm() {
    document.getElementById('loading').classList.add('hidden');
    document.getElementById('appealForm').classList.remove('hidden');

    // Set member name
    document.getElementById('memberName').textContent = memberData.member_name;

    // Show current departments
    const container = document.getElementById('currentDepartments');
    if (memberData.approved_departments && memberData.approved_departments.length > 0) {
        container.innerHTML = memberData.approved_departments.map(d => `
            <div class="flex items-center gap-2 p-2 bg-green-50 rounded-lg">
                <svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
                <span class="text-sm font-medium text-gray-900">${d.name}</span>
                ${d.category_name ? `<span class="text-xs text-gray-500">(${d.category_name})</span>` : ''}
            </div>
        `).join('');
    } else {
        container.innerHTML = '<p class="text-gray-500 text-sm">No approved departments.</p>';
    }

    // Populate dropdowns
    populateDropdowns();
}

function populateDropdowns() {
    // Unwanted dropdown - only show approved departments
    const unwantedSelect = document.getElementById('unwantedDept');
    const approvedIds = (memberData.approved_departments || []).map(d => d.id);

    memberData.approved_departments.forEach(d => {
        const option = document.createElement('option');
        option.value = d.id;
        option.textContent = d.name + (d.category_name ? ` (${d.category_name})` : '');
        unwantedSelect.appendChild(option);
    });

    // Wanted dropdown - show all departments (except currently approved)
    const wantedSelect = document.getElementById('wantedDept');
    allDepartments.filter(d => !approvedIds.includes(d.id)).forEach(d => {
        const option = document.createElement('option');
        option.value = d.id;
        option.textContent = d.name + (d.categoryName ? ` (${d.categoryName})` : '');
        wantedSelect.appendChild(option);
    });
}

async function submitAppeal() {
    const unwanted = document.getElementById('unwantedDept').value;
    const wanted = document.getElementById('wantedDept').value;
    const reason = document.getElementById('reason').value.trim();

    // At least one field should be filled
    if (!unwanted && !wanted && !reason) {
        showFormError('Please specify what you want to change or provide a reason.');
        return;
    }

    const btn = document.getElementById('submitBtn');
    btn.disabled = true;
    btn.textContent = 'Submitting...';

    try {
        const response = await fetch('/api/appeals', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                phone: phone,
                unwanted_department_id: unwanted ? parseInt(unwanted) : null,
                wanted_department_id: wanted ? parseInt(wanted) : null,
                reason: reason || null
            })
        });

        const data = await response.json();

        if (!response.ok) {
            throw new Error(data.detail || 'Failed to submit appeal');
        }

        // Show success
        document.getElementById('appealForm').classList.add('hidden');
        document.getElementById('successState').classList.remove('hidden');

    } catch (error) {
        console.error('Submit error:', error);
        showFormError(error.message || 'Failed to submit appeal. Please try again.');
        btn.disabled = false;
        btn.textContent = 'Submit Appeal';
    }
}

function showFormError(message) {
    const errorDiv = document.getElementById('formError');
    errorDiv.textContent = message;
    errorDiv.classList.remove('hidden');
}
</script>
{% endblock %}
