{% extends "base.html" %}

{% block title %}My Portal - RFM Stellenbosch 2026{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-indigo-100 via-purple-50 to-pink-100">
    <!-- Header -->
    <div class="sticky top-0 z-10 backdrop-blur-lg bg-white/70 shadow-sm">
        <div class="max-w-md mx-auto px-4 py-4 sm:py-6">
            <div class="flex items-center gap-3">
                <a href="/" class="text-gray-500 hover:text-gray-700 p-1">
                    <svg class="w-5 h-5 sm:w-6 sm:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                    </svg>
                </a>
                <div>
                    <h1 class="text-xl sm:text-2xl font-bold bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent">
                        My Portal
                    </h1>
                    <p class="text-gray-600 text-xs sm:text-sm">RFM Stellenbosch <span id="yearDisplay">2026</span></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="max-w-md mx-auto px-4 py-6 space-y-4">
        <!-- Loading -->
        <div id="loading" class="flex justify-center py-12">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div>
        </div>

        <!-- Error State -->
        <div id="errorState" class="hidden bg-white rounded-2xl shadow-lg p-6 text-center">
            <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                </svg>
            </div>
            <h3 class="text-lg font-semibold text-gray-900" id="errorTitle">Error</h3>
            <p class="text-gray-500 mt-2" id="errorMessage"></p>
            <a href="/" class="inline-block mt-4 text-indigo-600 hover:underline">Back to Home</a>
        </div>

        <!-- Family Profile Selector -->
        <div id="profileSelector" class="hidden bg-white rounded-2xl shadow-lg p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-2">Select Profile</h3>
            <p class="text-sm text-gray-500 mb-4">Multiple members found with this phone number. Please select your profile:</p>
            <div id="profileList" class="space-y-2"></div>
        </div>

        <!-- Main Portal Content -->
        <div id="portalContent" class="hidden space-y-4">
            <!-- Member Info Card -->
            <div class="bg-white rounded-2xl shadow-lg p-5">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-lg font-semibold text-gray-900" id="memberName"></h2>
                        <p class="text-sm text-gray-500" id="memberPhone"></p>
                    </div>
                    <button onclick="showProfileSelector()" id="switchProfileBtn" class="hidden text-sm text-indigo-600 hover:underline">
                        Switch Profile
                    </button>
                </div>
            </div>

            <!-- Results Not Published -->
            <div id="notPublishedState" class="hidden bg-yellow-50 border border-yellow-200 rounded-2xl p-6 text-center">
                <div class="w-14 h-14 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-7 h-7 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>
                <h3 class="text-lg font-semibold text-gray-900">Results Pending</h3>
                <p class="text-gray-600 mt-2 text-sm">
                    Your department selections are being reviewed. Results will be published soon.
                </p>
            </div>

            <!-- Published Results Section -->
            <div id="publishedState" class="hidden space-y-4">
                <!-- Provisional Notice -->
                <div id="provisionalNotice" class="hidden bg-amber-50 border border-amber-200 rounded-xl p-4">
                    <div class="flex items-start gap-3">
                        <svg class="w-5 h-5 text-amber-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <div>
                            <p class="text-sm font-medium text-amber-800">Provisional Approval</p>
                            <p class="text-xs text-amber-700 mt-1">These placements are provisional while the appeal window is open. You may submit an appeal if you wish to request changes.</p>
                        </div>
                    </div>
                </div>

                <!-- Approved Departments -->
                <div class="bg-white rounded-2xl shadow-lg p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Your Approved Departments</h3>
                    <div id="approvedList" class="space-y-3"></div>
                    <div id="noApprovedMessage" class="hidden text-center py-4 text-gray-500">
                        No departments have been approved yet.
                    </div>
                </div>

                <!-- Admin Added Departments (need acceptance) -->
                <div id="adminAddedSection" class="hidden bg-blue-50 border border-blue-200 rounded-2xl p-6">
                    <h3 class="text-base font-semibold text-blue-900 mb-2">Additional Assignments</h3>
                    <p class="text-sm text-blue-700 mb-4">The following departments were assigned to you by an admin:</p>
                    <div id="adminAddedList" class="space-y-3"></div>
                </div>

                <!-- Pending Departments -->
                <div id="pendingSection" class="hidden bg-gray-50 rounded-2xl p-6">
                    <h3 class="text-base font-semibold text-gray-700 mb-3">Pending Review</h3>
                    <div id="pendingList" class="space-y-2"></div>
                </div>

                <!-- Rejected Departments -->
                <div id="rejectedSection" class="hidden bg-red-50 rounded-2xl p-6">
                    <h3 class="text-base font-semibold text-red-800 mb-3">Not Approved</h3>
                    <div id="rejectedList" class="space-y-2"></div>
                </div>

                <!-- Actions -->
                <div class="space-y-3">
                    <a href="#" id="updateLink" class="block bg-white rounded-xl shadow p-4 hover:shadow-lg transition-all">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center flex-shrink-0">
                                <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                </svg>
                            </div>
                            <div>
                                <p class="font-medium text-gray-900">Update My Selection</p>
                                <p class="text-xs text-gray-500">Change your department preferences</p>
                            </div>
                        </div>
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Appeal Modal -->
<div id="appealModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-xl max-w-md w-full max-h-[90vh] overflow-y-auto">
        <div class="p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Submit Appeal</h3>

            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        Department you want to appeal
                    </label>
                    <select id="appealDept" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-amber-500">
                        <option value="">-- Select department --</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        Department you want instead <span class="text-gray-400">(optional)</span>
                    </label>
                    <select id="wantedDept" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-amber-500">
                        <option value="">-- Select department --</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        Reason for appeal <span class="text-gray-400">(optional)</span>
                    </label>
                    <textarea id="appealReason" rows="3" placeholder="Explain why you're appealing..."
                        class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-amber-500 resize-none"></textarea>
                </div>

                <div id="appealError" class="hidden text-sm text-red-600"></div>
            </div>

            <div class="flex gap-3 mt-6">
                <button onclick="closeAppealModal()" class="flex-1 py-3 border border-gray-300 text-gray-700 font-medium rounded-xl hover:bg-gray-50">
                    Cancel
                </button>
                <button onclick="submitAppeal()" id="submitAppealBtn" class="flex-1 py-3 bg-amber-600 text-white font-medium rounded-xl hover:bg-amber-700">
                    Submit Appeal
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let phone = '';
let allData = null;
let currentMember = null;
let allDepartments = [];

document.addEventListener('DOMContentLoaded', init);

async function init() {
    // Get phone from URL
    const params = new URLSearchParams(window.location.search);
    phone = params.get('phone');

    if (!phone) {
        showError('Missing Information', 'Please access this page from the home page.');
        return;
    }

    try {
        // Fetch data
        const [resultsRes, deptsRes] = await Promise.all([
            fetch(`/api/results?phone=${encodeURIComponent(phone)}`).then(r => r.json()),
            fetch('/api/departments').then(r => r.json())
        ]);

        allData = resultsRes;

        // Flatten departments for appeal dropdown
        allDepartments = [];
        (deptsRes.categories || []).forEach(cat => {
            cat.departments.forEach(d => {
                allDepartments.push({ ...d, categoryName: cat.name });
            });
        });
        (deptsRes.uncategorized || []).forEach(d => {
            allDepartments.push({ ...d, categoryName: null });
        });

        document.getElementById('yearDisplay').textContent = allData.year || '2026';

        if (!allData.members || allData.members.length === 0) {
            showError('Not Found', 'No registration found for this phone number.');
            return;
        }

        document.getElementById('loading').classList.add('hidden');

        // If multiple members (family), show profile selector
        if (allData.is_family && allData.members.length > 1) {
            showProfileSelector();
        } else {
            // Single member, show portal directly
            selectMember(allData.members[0]);
        }

    } catch (error) {
        console.error('Init error:', error);
        showError('Error', 'Failed to load data. Please try again.');
    }
}

function showError(title, message) {
    document.getElementById('loading').classList.add('hidden');
    document.getElementById('errorState').classList.remove('hidden');
    document.getElementById('errorTitle').textContent = title;
    document.getElementById('errorMessage').textContent = message;
}

function showProfileSelector() {
    document.getElementById('profileSelector').classList.remove('hidden');
    document.getElementById('portalContent').classList.add('hidden');

    const list = document.getElementById('profileList');
    list.innerHTML = allData.members.map(m => `
        <button onclick="selectMember(${JSON.stringify(m).replace(/"/g, '&quot;')})"
            class="w-full p-4 bg-gray-50 rounded-xl hover:bg-indigo-50 hover:border-indigo-300 border-2 border-transparent transition-all text-left">
            <p class="font-medium text-gray-900">${m.full_name}</p>
            <p class="text-sm text-gray-500">${m.approved_departments.length} approved department(s)</p>
        </button>
    `).join('');
}

function selectMember(member) {
    currentMember = member;

    document.getElementById('profileSelector').classList.add('hidden');
    document.getElementById('portalContent').classList.remove('hidden');

    // Show switch button if family
    if (allData.is_family && allData.members.length > 1) {
        document.getElementById('switchProfileBtn').classList.remove('hidden');
    }

    // Member info
    document.getElementById('memberName').textContent = member.full_name;
    document.getElementById('memberPhone').textContent = phone;

    // Update links
    document.getElementById('updateLink').href = `/update?phone=${encodeURIComponent(phone)}&member_id=${member.id}`;

    if (allData.published) {
        document.getElementById('publishedState').classList.remove('hidden');
        document.getElementById('notPublishedState').classList.add('hidden');

        // Show provisional notice if appeal window is open
        if (allData.appeal_window_open) {
            document.getElementById('provisionalNotice').classList.remove('hidden');
        }

        renderDepartments(member);
    } else {
        document.getElementById('publishedState').classList.add('hidden');
        document.getElementById('notPublishedState').classList.remove('hidden');
    }
}

function renderDepartments(member) {
    const canAppeal = allData.appeal_window_open;

    // Approved departments
    const approvedList = document.getElementById('approvedList');
    if (member.approved_departments.length > 0) {
        approvedList.innerHTML = member.approved_departments.map(d => {
            const isAdminAdded = d.source === 'admin';
            const bgColor = isAdminAdded ? 'bg-blue-50 border border-blue-200' : 'bg-green-50';
            const iconBg = isAdminAdded ? 'bg-blue-100' : 'bg-green-100';
            const iconColor = isAdminAdded ? 'text-blue-600' : 'text-green-600';

            return `
            <div class="${bgColor} rounded-xl p-3">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 ${iconBg} rounded-full flex items-center justify-center flex-shrink-0">
                        ${isAdminAdded ? `
                            <svg class="w-5 h-5 ${iconColor}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                            </svg>
                        ` : `
                            <svg class="w-5 h-5 ${iconColor}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                            </svg>
                        `}
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="font-medium text-gray-900">${d.department_name}</p>
                        ${d.category_name ? `<p class="text-xs text-gray-500">${d.category_name}</p>` : ''}
                        ${isAdminAdded ? `<p class="text-xs text-blue-600 font-medium mt-1">Added by Admin</p>` : ''}
                    </div>
                </div>
                ${canAppeal ? `
                    <div class="mt-3 pt-3 border-t ${isAdminAdded ? 'border-blue-200' : 'border-green-200'}">
                        <button onclick="openAppealForDept(${d.department_id}, '${d.department_name.replace(/'/g, "\\'")}', ${isAdminAdded})"
                            class="w-full py-2 ${isAdminAdded ? 'bg-amber-500 hover:bg-amber-600' : 'bg-amber-100 hover:bg-amber-200 text-amber-700'} ${isAdminAdded ? 'text-white' : ''} text-sm font-medium rounded-lg transition-colors flex items-center justify-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path>
                            </svg>
                            ${isAdminAdded ? 'Appeal This Assignment' : 'Appeal'}
                        </button>
                    </div>
                ` : ''}
            </div>
        `}).join('');
        document.getElementById('noApprovedMessage').classList.add('hidden');
    } else {
        approvedList.innerHTML = '';
        document.getElementById('noApprovedMessage').classList.remove('hidden');
    }

    // Admin added (unapproved, source=admin) - need acceptance
    const adminAdded = member.all_selections.filter(s => s.source === 'admin' && s.status !== 'approved');
    if (adminAdded.length > 0) {
        document.getElementById('adminAddedSection').classList.remove('hidden');
        document.getElementById('adminAddedList').innerHTML = adminAdded.map(d => `
            <div class="bg-white rounded-xl p-3 border border-blue-100">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="font-medium text-gray-900">${d.department_name}</p>
                        ${d.category_name ? `<p class="text-xs text-gray-500">${d.category_name}</p>` : ''}
                    </div>
                </div>
                <div class="mt-3 flex gap-2">
                    <button onclick="acceptAssignment(${d.id})"
                        class="flex-1 py-2 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700">
                        Accept
                    </button>
                    ${canAppeal ? `
                        <button onclick="openAppealForDept(${d.department_id}, '${d.department_name.replace(/'/g, "\\'")}', true)"
                            class="flex-1 py-2 bg-amber-500 text-white text-sm font-medium rounded-lg hover:bg-amber-600">
                            Appeal
                        </button>
                    ` : ''}
                </div>
            </div>
        `).join('');
    } else {
        document.getElementById('adminAddedSection').classList.add('hidden');
    }

    // Pending departments
    if (member.pending_departments.length > 0) {
        document.getElementById('pendingSection').classList.remove('hidden');
        document.getElementById('pendingList').innerHTML = member.pending_departments.map(d => `
            <div class="flex items-center gap-2 p-2 bg-white rounded-lg">
                <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <span class="text-sm text-gray-700">${d.department_name}</span>
                ${d.category_name ? `<span class="text-xs text-gray-400">(${d.category_name})</span>` : ''}
            </div>
        `).join('');
    } else {
        document.getElementById('pendingSection').classList.add('hidden');
    }

    // Rejected departments
    if (member.rejected_departments.length > 0) {
        document.getElementById('rejectedSection').classList.remove('hidden');
        document.getElementById('rejectedList').innerHTML = member.rejected_departments.map(d => `
            <div class="flex items-center gap-2 p-2 bg-white rounded-lg">
                <svg class="w-4 h-4 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
                <span class="text-sm text-gray-700">${d.department_name}</span>
                ${d.admin_note ? `<span class="text-xs text-red-500 italic ml-2">${d.admin_note}</span>` : ''}
            </div>
        `).join('');
    } else {
        document.getElementById('rejectedSection').classList.add('hidden');
    }
}

async function acceptAssignment(memberDeptId) {
    try {
        const response = await fetch(`/api/results/accept/${memberDeptId}?phone=${encodeURIComponent(phone)}`, {
            method: 'POST'
        });

        if (!response.ok) {
            const data = await response.json();
            alert(data.detail || 'Failed to accept assignment');
            return;
        }

        // Refresh data
        location.reload();

    } catch (error) {
        console.error('Accept error:', error);
        alert('Failed to accept assignment. Please try again.');
    }
}

function openAppealForDept(deptId, deptName, isAdminAdded) {
    openAppealModal(deptId);

    // Update modal title for admin-added
    const modalTitle = document.querySelector('#appealModal h3');
    if (isAdminAdded) {
        modalTitle.innerHTML = `Appeal Admin Assignment`;
    } else {
        modalTitle.innerHTML = `Submit Appeal`;
    }
}

function openAppealModal(preselectedDeptId = null) {
    document.getElementById('appealModal').classList.remove('hidden');

    // Populate dropdowns
    const appealDept = document.getElementById('appealDept');
    const wantedDept = document.getElementById('wantedDept');

    // Clear and populate
    appealDept.innerHTML = '<option value="">-- Select department --</option>';
    wantedDept.innerHTML = '<option value="">-- Select department --</option>';

    // Appeal dropdown: approved departments AND admin-added pending departments
    const appealableDepts = [
        ...currentMember.approved_departments,
        ...currentMember.all_selections.filter(s => s.source === 'admin' && s.status !== 'approved')
    ];

    appealableDepts.forEach(d => {
        const opt = document.createElement('option');
        opt.value = d.department_id;
        const isAdminAdded = d.source === 'admin';
        opt.textContent = d.department_name + (d.category_name ? ` (${d.category_name})` : '') + (isAdminAdded ? ' [Admin Added]' : '');
        appealDept.appendChild(opt);
    });

    // Pre-select if specified
    if (preselectedDeptId) {
        appealDept.value = preselectedDeptId;
    }

    // Wanted dropdown: all departments except already approved/assigned
    const assignedIds = new Set(currentMember.all_selections.map(d => d.department_id));
    allDepartments.filter(d => !assignedIds.has(d.id)).forEach(d => {
        const opt = document.createElement('option');
        opt.value = d.id;
        opt.textContent = d.name + (d.categoryName ? ` (${d.categoryName})` : '');
        wantedDept.appendChild(opt);
    });
}

function closeAppealModal() {
    document.getElementById('appealModal').classList.add('hidden');
    document.getElementById('appealError').classList.add('hidden');
}

async function submitAppeal() {
    const unwantedId = document.getElementById('appealDept').value;
    const wantedId = document.getElementById('wantedDept').value;
    const reason = document.getElementById('appealReason').value.trim();
    const errorDiv = document.getElementById('appealError');

    if (!unwantedId && !wantedId && !reason) {
        errorDiv.textContent = 'Please specify what you want to change or provide a reason.';
        errorDiv.classList.remove('hidden');
        return;
    }

    const btn = document.getElementById('submitAppealBtn');
    btn.disabled = true;
    btn.textContent = 'Submitting...';

    try {
        const response = await fetch('/api/appeals', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                phone: phone,
                member_id: currentMember.id,
                unwanted_department_id: unwantedId ? parseInt(unwantedId) : null,
                wanted_department_id: wantedId ? parseInt(wantedId) : null,
                reason: reason || null
            })
        });

        const data = await response.json();

        if (!response.ok) {
            throw new Error(data.detail || 'Failed to submit appeal');
        }

        closeAppealModal();
        alert('Your appeal has been submitted successfully. An admin will review it shortly.');

    } catch (error) {
        console.error('Appeal error:', error);
        errorDiv.textContent = error.message || 'Failed to submit appeal. Please try again.';
        errorDiv.classList.remove('hidden');
    } finally {
        btn.disabled = false;
        btn.textContent = 'Submit Appeal';
    }
}
</script>
{% endblock %}
